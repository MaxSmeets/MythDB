{% extends "base.html" %}

{% block title %}MythDB ¬∑ {{ project.name }} ¬∑ {{ article.title }}{% endblock %}

{% block content %}
<div class="article-layout">
  <aside class="sidebar" aria-label="Article metadata">
    {% if article.featured_image %}
    <div class="article-image-container">
      <img 
        src="/projects/{{ project.slug }}/media/files/{{ article.featured_image }}" 
        alt="Featured image for {{ article.title }}"
        class="article-image"
      >
      <button type="button" id="changeImageBtn" class="btn-change-image">Change Image</button>
    </div>
    {% else %}
    <div id="imagePickerPlaceholder" class="article-image-placeholder">
      <div class="placeholder-content">
        <div class="placeholder-icon">üñºÔ∏è</div>
        <p class="placeholder-text">No featured image</p>
        <button type="button" id="selectImageBtn" class="btn btn-secondary">Select Image</button>
      </div>
    </div>
    {% endif %}

    <!-- Image Selection Dropdown -->
    <div id="imageDropdown" class="image-dropdown hidden">
      <input 
        type="text" 
        id="imageSearchInput" 
        class="image-search" 
        placeholder="Search media..."
        spellcheck="false"
      >
      <div id="imageList" class="image-dropdown-list"></div>
    </div>

    <div class="card">
      <h3 class="card-title">Structured fields</h3>
      <p class="card-meta muted">Coming next (field definitions + values).</p>
    </div>

    <div class="card card-collapsible" id="metadataCard">
      <div class="card-header-row">
        <h3 class="card-title">Metadata</h3>
        <button type="button" class="btn-collapse" aria-expanded="false">‚ñº</button>
      </div>
      <div class="card-content hidden" id="metadataContent">
        <p class="card-meta"><strong>ID:</strong> {{ article.id }}</p>
        <p class="card-meta"><strong>Slug:</strong> {{ article.slug }}</p>
        <p class="card-meta"><strong>Created:</strong> {{ article.created_at }}</p>
        <p class="card-meta"><strong>Updated:</strong> {{ article.updated_at }}</p>
      </div>
    </div>
  </aside>

  <div class="article-main">
    <header class="page-header">
      <p class="breadcrumb">
        <a href="{{ url_for('projects.projects_overview') }}">Projects</a>
        <span aria-hidden="true">/</span>
        <a href="{{ url_for('projects.project_home', slug=project.slug) }}">{{ project.name }}</a>
        <span aria-hidden="true">/</span>
        <span>{{ article.title }}</span>
      </p>

      <div class="article-header-row">
        <div>
          <h2>{{ article.title }}</h2>
          <p class="muted">
             {{ article.type_name }}
          </p>
        </div>
        <button id="modeToggle" class="btn" data-mode="read">‚úèÔ∏è Edit</button>
      </div>
    </header>

    <!-- Read mode -->
    <article id="readMode" class="article-body markdown" aria-label="Article body">
      {{ rendered_html | safe }}
    </article>

    <!-- Edit mode -->
    <form id="editMode" method="post" action="{{ url_for('articles.edit_article', slug=project.slug, article_id=article.id) }}" class="article-editor hidden">
      <div class="editor-toolbar">
        <button type="button" id="linkArticleBtn" class="btn btn-secondary" title="Link to another article">üîó Link Article</button>
        
        <!-- Article Link Dropdown -->
        <div id="linkDropdown" class="article-link-dropdown hidden">
          <input 
            type="text" 
            id="articleSearchInput" 
            class="article-search" 
            placeholder="Search articles..."
            spellcheck="false"
          >
          <div id="articleList" class="article-dropdown-list"></div>
        </div>
      </div>
      
      <textarea 
        name="body_content" 
        class="editor-textarea" 
        id="editorTextarea"
        required 
        placeholder="Write your markdown here..."
        spellcheck="false"
      >{{ article.body_content }}</textarea>

      <div class="editor-actions">
        <button type="submit" class="btn">üíæ Save</button>
        <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const modeToggle = document.getElementById('modeToggle');
  const readMode = document.getElementById('readMode');
  const editMode = document.getElementById('editMode');
  const cancelEdit = document.getElementById('cancelEdit');
  
  let currentMode = 'read';

  modeToggle.addEventListener('click', () => {
    if (currentMode === 'read') {
      // Switch to edit
      readMode.classList.add('hidden');
      editMode.classList.remove('hidden');
      modeToggle.textContent = 'üëÅÔ∏è View';
      modeToggle.dataset.mode = 'edit';
      currentMode = 'edit';
      editMode.querySelector('textarea').focus();
    } else {
      // Switch to read
      readMode.classList.remove('hidden');
      editMode.classList.add('hidden');
      modeToggle.textContent = '‚úèÔ∏è Edit';
      modeToggle.dataset.mode = 'read';
      currentMode = 'read';
    }
  });

  cancelEdit.addEventListener('click', () => {
    // Reset textarea to original content
    const textarea = editMode.querySelector('textarea');
    textarea.value = textarea.defaultValue;
    // Switch back to read mode
    modeToggle.click();
  });

  // Article linking functionality
  const linkArticleBtn = document.getElementById('linkArticleBtn');
  const linkDropdown = document.getElementById('linkDropdown');
  const articleSearchInput = document.getElementById('articleSearchInput');
  const articleList = document.getElementById('articleList');
  const editorTextarea = document.getElementById('editorTextarea');
  
  let allArticles = [];

  // Fetch articles from API
  async function loadArticles() {
    const projectSlug = '{{ project.slug }}';
    const articleId = parseInt('{{ article.id }}', 10);
    
    try {
      const response = await fetch(`/projects/${projectSlug}/api/articles?exclude_id=${articleId}`);
      if (response.ok) {
        allArticles = await response.json();
        renderArticleList(allArticles);
      }
    } catch (error) {
      console.error('Failed to load articles:', error);
    }
  }

  // Render article list
  function renderArticleList(articles) {
    if (articles.length === 0) {
      articleList.innerHTML = '<div class="article-dropdown-empty">No articles found</div>';
      return;
    }
    
    articleList.innerHTML = articles.map(article => `
      <div class="article-dropdown-item" data-slug="${article.slug}" data-title="${article.title}">
        <div class="article-dropdown-title">${article.title}</div>
        <div class="article-dropdown-type">${article.type_name}</div>
      </div>
    `).join('');
    
    // Add click handlers to items
    document.querySelectorAll('.article-dropdown-item').forEach(item => {
      item.addEventListener('click', () => {
        insertArticleLink(item.dataset.slug, item.dataset.title);
        linkDropdown.classList.add('hidden');
      });
    });
  }

  // Filter articles based on search
  function filterArticles(searchTerm) {
    const filtered = allArticles.filter(article => 
      article.title.toLowerCase().includes(searchTerm.toLowerCase())
    );
    renderArticleList(filtered);
  }

  // Insert article link at cursor position
  function insertArticleLink(slug, title) {
    const textarea = editorTextarea;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const beforeCursor = textarea.value.substring(0, start);
    const afterCursor = textarea.value.substring(end);
    const markdownLink = `[${title}](article:${slug})`;
    
    textarea.value = beforeCursor + markdownLink + afterCursor;
    
    // Set cursor position after the inserted link
    const newPosition = start + markdownLink.length;
    textarea.selectionStart = newPosition;
    textarea.selectionEnd = newPosition;
    textarea.focus();
  }

  // Toggle dropdown on button click
  linkArticleBtn.addEventListener('click', (e) => {
    e.preventDefault();
    linkDropdown.classList.toggle('hidden');
    if (!linkDropdown.classList.contains('hidden')) {
      articleSearchInput.focus();
    }
  });

  // Filter articles as user types
  articleSearchInput.addEventListener('input', (e) => {
    filterArticles(e.target.value);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#linkArticleBtn') && !e.target.closest('#linkDropdown')) {
      linkDropdown.classList.add('hidden');
    }
  });

  // Load articles on page load
  loadArticles();

  // Image selection functionality
  const imageDropdown = document.getElementById('imageDropdown');
  const imageSearchInput = document.getElementById('imageSearchInput');
  const imageList = document.getElementById('imageList');
  const selectImageBtn = document.getElementById('selectImageBtn');
  const changeImageBtn = document.getElementById('changeImageBtn');
  const imagePickerPlaceholder = document.getElementById('imagePickerPlaceholder');
  
  let allMediaFiles = [];

  // Fetch media files from API
  async function loadMediaFiles() {
    const projectSlug = '{{ project.slug }}';
    
    try {
      const response = await fetch(`/projects/${projectSlug}/api/media`);
      if (response.ok) {
        allMediaFiles = await response.json();
        renderMediaList(allMediaFiles);
      }
    } catch (error) {
      console.error('Failed to load media files:', error);
    }
  }

  // Render media list
  function renderMediaList(files) {
    if (files.length === 0) {
      imageList.innerHTML = '<div class="image-dropdown-empty">No images found</div>';
      return;
    }
    
    imageList.innerHTML = files.map(file => `
      <div class="image-dropdown-item" data-filename="${file.filename}">
        <img src="${file.url}" alt="${file.filename}" class="image-dropdown-thumb">
        <div class="image-dropdown-name">${file.filename}</div>
      </div>
    `).join('');
    
    // Add click handlers to items
    document.querySelectorAll('.image-dropdown-item').forEach(item => {
      item.addEventListener('click', () => {
        selectImage(item.dataset.filename);
        imageDropdown.classList.add('hidden');
      });
    });
  }

  // Filter media files based on search
  function filterMediaFiles(searchTerm) {
    const filtered = allMediaFiles.filter(file => 
      file.filename.toLowerCase().includes(searchTerm.toLowerCase())
    );
    renderMediaList(filtered);
  }

  // Select image and update article
  async function selectImage(filename) {
    const projectSlug = '{{ project.slug }}';
    const articleId = parseInt('{{ article.id }}', 10);
    
    try {
      const response = await fetch(`/projects/${projectSlug}/a/${articleId}/api/set-image`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ featured_image: filename })
      });
      
      if (response.ok) {
        // Update the image display without reloading
        const mediaUrl = `/projects/${projectSlug}/media/files/${filename}`;
        
        // Replace placeholder with image if needed
        const placeholder = document.getElementById('imagePickerPlaceholder');
        if (placeholder && !placeholder.classList.contains('hidden')) {
          const container = document.createElement('div');
          container.className = 'article-image-container';
          container.innerHTML = `
            <img 
              src="${mediaUrl}" 
              alt="Featured image"
              class="article-image"
            >
            <button type="button" id="changeImageBtn" class="btn-change-image">Change Image</button>
          `;
          placeholder.replaceWith(container);
          
          // Re-attach event listener to the new button
          document.getElementById('changeImageBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            imageDropdown.classList.toggle('hidden');
            if (!imageDropdown.classList.contains('hidden')) {
              imageSearchInput.focus();
            }
          });
        } else {
          // Update existing image
          const img = document.querySelector('.article-image');
          if (img) {
            img.src = mediaUrl;
          }
        }
      } else {
        alert('Failed to set featured image');
      }
    } catch (error) {
      console.error('Error setting featured image:', error);
      alert('Error setting featured image');
    }
  }

  // Toggle dropdown on button click
  if (selectImageBtn) {
    selectImageBtn.addEventListener('click', (e) => {
      e.preventDefault();
      imageDropdown.classList.toggle('hidden');
      if (!imageDropdown.classList.contains('hidden')) {
        imageSearchInput.focus();
      }
    });
  }

  if (changeImageBtn) {
    changeImageBtn.addEventListener('click', (e) => {
      e.preventDefault();
      imageDropdown.classList.toggle('hidden');
      if (!imageDropdown.classList.contains('hidden')) {
        imageSearchInput.focus();
      }
    });
  }

  // Filter media as user types
  imageSearchInput.addEventListener('input', (e) => {
    filterMediaFiles(e.target.value);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#selectImageBtn') && 
        !e.target.closest('#changeImageBtn') && 
        !e.target.closest('#imageDropdown')) {
      imageDropdown.classList.add('hidden');
    }
  });

  // Metadata card collapse/expand
  const metadataCard = document.getElementById('metadataCard');
  const metadataContent = document.getElementById('metadataContent');
  const collapseBtn = metadataCard?.querySelector('.btn-collapse');
  
  if (collapseBtn) {
    collapseBtn.addEventListener('click', () => {
      const isExpanded = collapseBtn.getAttribute('aria-expanded') === 'true';
      collapseBtn.setAttribute('aria-expanded', !isExpanded);
      metadataContent.classList.toggle('hidden');
    });
  }

  // Load media files on page load
  loadMediaFiles();
</script>
{% endblock %}
