{% extends "base.html" %}

{% block title %}MythDB ¬∑ {{ project.name }} ¬∑ {{ article.title }}{% endblock %}

{% block content %}
<div class="article-layout" data-project-slug="{{ project.slug }}" data-article-id="{{ article.id }}">
  <aside class="sidebar" aria-label="Article metadata">
    {% if article.featured_image %}
    <div class="article-image-container">
      <img 
        src="/projects/{{ project.slug }}/media/files/{{ article.featured_image }}" 
        alt="Featured image for {{ article.title }}"
        class="article-image"
      >
      <button type="button" id="changeImageBtn" class="btn-change-image">Change Image</button>
    </div>
    {% else %}
    <div id="imagePickerPlaceholder" class="article-image-placeholder">
      <div class="placeholder-content">
        <div class="placeholder-icon">üñºÔ∏è</div>
        <p class="placeholder-text">No featured image</p>
        <button type="button" id="selectImageBtn" class="btn btn-secondary">Select Image</button>
      </div>
    </div>
    {% endif %}

    <!-- Image Selection Dropdown -->
    <div id="imageDropdown" class="image-dropdown hidden">
      <input 
        type="text" 
        id="imageSearchInput" 
        class="image-search" 
        placeholder="Search media..."
        spellcheck="false"
      >
      <div id="imageList" class="image-dropdown-list"></div>
    </div>

    <div class="card">
      <h3 class="card-title">Structured fields</h3>
      {% if prompts %}
      <div class="structured-fields">
        {% for prompt in prompts %}
        <div class="field-group" data-prompt-id="{{ prompt.id }}" data-prompt-key="{{ prompt.key }}" data-prompt-type="{{ prompt.type }}">
          <label class="field-label">{{ prompt.text }}</label>
          
          {% if prompt.type == "text" %}
          <input 
            type="text" 
            class="field-input" 
            placeholder="Enter value..."
            value="{{ prompt_values.get(prompt.key, {}).get('value', '') or '' }}"
          >
          
          {% elif prompt.type == "select" %}
          <select class="field-input field-select">
            <option value="">‚Äî Select ‚Äî</option>
            {% for article in linked_articles_by_key.get(prompt.key, []) %}
            <option 
              value="{{ article.id }}"
              {% if prompt_values.get(prompt.key, {}).get('linked_article_id') == article.id %}selected{% endif %}
            >
              {{ article.title }}
            </option>
            {% endfor %}
          </select>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="card-meta muted">No structured fields defined for this article type.</p>
      {% endif %}
    </div>

    <div class="card card-collapsible" id="metadataCard">
      <div class="card-header-row">
        <h3 class="card-title">Metadata</h3>
        <button type="button" class="btn-collapse" aria-expanded="false">‚ñº</button>
      </div>
      <div class="card-content hidden" id="metadataContent">
        <p class="card-meta"><strong>ID:</strong> {{ article.id }}</p>
        <p class="card-meta"><strong>Slug:</strong> {{ article.slug }}</p>
        <p class="card-meta"><strong>Created:</strong> {{ article.created_at }}</p>
        <p class="card-meta"><strong>Updated:</strong> {{ article.updated_at }}</p>
      </div>
    </div>
  </aside>

  <div class="article-main">
    <header class="page-header">
      <p class="breadcrumb">
        <a href="{{ url_for('projects.projects_overview') }}">Projects</a>
        <span aria-hidden="true">/</span>
        <a href="{{ url_for('projects.project_home', slug=project.slug) }}">{{ project.name }}</a>
        <span aria-hidden="true">/</span>
        <span>{{ article.title }}</span>
      </p>

      <div class="article-header-row">
        <div>
          <h2>{{ article.title }}</h2>
          <p class="muted">
             {{ article.type_name }}
          </p>
        </div>
        <button id="modeToggle" class="btn" data-mode="read">‚úèÔ∏è Edit</button>
      </div>
    </header>

    <!-- Read mode -->
    <article id="readMode" class="article-body markdown" aria-label="Article body">
      {{ rendered_html | safe }}
    </article>

    <!-- Edit mode -->
    <form id="editMode" method="post" action="{{ url_for('articles.edit_article', slug=project.slug, article_id=article.id) }}" class="article-editor hidden">
      <div class="editor-toolbar">
        <button type="button" id="linkArticleBtn" class="btn btn-secondary" title="Link to another article">üîó Link Article</button>
        
        <!-- Article Link Dropdown -->
        <div id="linkDropdown" class="article-link-dropdown hidden">
          <input 
            type="text" 
            id="articleSearchInput" 
            class="article-search" 
            placeholder="Search articles..."
            spellcheck="false"
          >
          <div id="articleList" class="article-dropdown-list"></div>
        </div>
      </div>
      
      <textarea 
        name="body_content" 
        class="editor-textarea" 
        id="editorTextarea"
        required 
        placeholder="Write your markdown here..."
        spellcheck="false"
      >{{ article.body_content }}</textarea>

      <div class="editor-actions">
        <button type="submit" class="btn">üíæ Save</button>
        <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/article.js') }}"></script>
{% endblock %}