{% extends "base.html" %}
{% from "components/markdown_editor.html" import render_markdown_editor %}
{% from "components/markdown_modals.html" import render_markdown_modals %}

{% block title %}MythDB ¬∑ {{ project.name }} ¬∑ {{ article.title }}{% endblock %}

{% block content %}
<div class="article-layout" data-project-slug="{{ project.slug }}" data-article-id="{{ article.id }}">
  <header class="page-header">
    <p class="breadcrumb">
      <a href="{{ url_for('projects.projects_overview') }}">Projects</a>
      <span aria-hidden="true">/</span>
      <a href="{{ url_for('projects.project_home', slug=project.slug) }}">{{ project.name }}</a>
      <span aria-hidden="true">/</span>
      <span>{{ article.title }}</span>
    </p>

    <div class="article-header-row">
      <div>
        <h2>{{ article.title }}</h2>
        <p class="muted">
           {{ article.type_name }}
        </p>
      </div>
      <div class="header-actions">
        <button id="saveBtn" class="btn btn-primary hidden">üíæ Save</button>
        <button id="cancelEditBtn" class="btn btn-secondary hidden">‚úï Cancel</button>
        <button id="modeToggle" class="btn" data-mode="read">‚úèÔ∏è Edit</button>
      </div>
    </div>
  </header>

  <aside class="sidebar" aria-label="Article metadata">
    {% if article.featured_image %}
    <div class="article-image-container">
      <img 
        src="/projects/{{ project.slug }}/media/files/{{ article.featured_image }}" 
        alt="Featured image for {{ article.title }}"
        class="article-image"
        id="featuredImage"
        style="cursor: pointer;"
      >
      <button type="button" id="changeImageBtn" class="btn-change-image hidden">Change Image</button>
    </div>
    {% else %}
    <div id="imagePickerPlaceholder" class="article-image-placeholder">
      <div class="placeholder-content">
        <div class="placeholder-icon">üñºÔ∏è</div>
        <p class="placeholder-text">No featured image</p>
        <button type="button" id="selectImageBtn" class="btn btn-secondary hidden">Select Image</button>
      </div>
    </div>
    {% endif %}

    <!-- Image Selection Dropdown -->
    <div id="imageDropdown" class="image-dropdown hidden">
      <input 
        type="text" 
        id="imageSearchInput" 
        class="image-search" 
        placeholder="Search media..."
        spellcheck="false"
      >
      <div id="imageList" class="image-dropdown-list"></div>
    </div>

    <div class="card">
      <h3 class="card-title">Structured fields</h3>
      {% if prompts %}
      
      <!-- View mode: Display as key-value pairs -->
      <div id="viewModeFields" class="view-mode-fields">
        {% for prompt in prompts %}
        {% set prompt_value = prompt_values.get(prompt.key, {}) %}
        {% if prompt.type == "text" and prompt_value.get('value') %}
        <div class="field-display">
          <span class="field-label">{{ prompt.text }}:</span>
          <span class="field-value">{{ prompt_value.get('value') }}</span>
        </div>
        {% elif prompt.type == "select" and prompt_value.get('linked_article_id') %}
        <div class="field-display">
          <span class="field-label">{{ prompt.text }}:</span>
          {% set linked_article = linked_articles_by_key.get(prompt.key, []) | selectattr('id', 'equalto', prompt_value.get('linked_article_id')) | first %}
          {% if linked_article %}
            <a href="{{ url_for('articles.article_view', slug=project.slug, article_id=linked_article.id) }}" class="field-link">{{ linked_article.title }}</a>
          {% endif %}
        </div>
        {% endif %}
        {% endfor %}
      </div>
      
      <!-- Edit mode: Display as form fields -->
      <div id="editModeFields" class="structured-fields hidden">
        {% for prompt in prompts %}
        <div class="field-group" data-prompt-id="{{ prompt.id }}" data-prompt-key="{{ prompt.key }}" data-prompt-type="{{ prompt.type }}">
          <div class="field-label-container">
            <label class="field-label">{{ prompt.text }}</label>
            {% if prompt.type == "select" and prompt_linked_type_keys.get(prompt.key) %}
            <div class="tooltip-trigger" data-tooltip-key="{{ prompt.key }}" data-linked-type="{{ prompt_linked_type_keys.get(prompt.key) }}" title="Show article types this field links to">
              ‚ìò
            </div>
            <div class="tooltip-content" data-tooltip-key="{{ prompt.key }}">
              <strong>Links to:</strong> {{ prompt_linked_type_keys.get(prompt.key).replace('_', ' ').title() }}
            </div>
            {% endif %}
          </div>
          
          {% if prompt.type == "text" %}
          <input 
            type="text" 
            class="field-input" 
            placeholder="Enter value..."
            value="{{ prompt_values.get(prompt.key, {}).get('value', '') or '' }}"
            disabled
          >
          
          {% elif prompt.type == "select" %}
          <select class="field-input field-select" disabled>
            <option value="">‚Äî Select ‚Äî</option>
            {% for article in linked_articles_by_key.get(prompt.key, []) %}
            <option 
              value="{{ article.id }}"
              {% if prompt_values.get(prompt.key, {}).get('linked_article_id') == article.id %}selected{% endif %}
            >
              {{ article.title }}
            </option>
            {% endfor %}
          </select>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      
      {% else %}
      <p class="card-meta muted">No structured fields defined for this article type.</p>
      {% endif %}
    </div>

    <div class="card card-collapsible" id="metadataCard">
      <div class="card-header-row">
        <h3 class="card-title">Metadata</h3>
        <button type="button" class="btn-collapse" aria-expanded="false">‚ñº</button>
      </div>
      <div class="card-content hidden" id="metadataContent">
        <p class="card-meta"><strong>ID:</strong> {{ article.id }}</p>
        <p class="card-meta"><strong>Slug:</strong> {{ article.slug }}</p>
        <p class="card-meta"><strong>Created:</strong> {{ article.created_at }}</p>
        <p class="card-meta"><strong>Updated:</strong> {{ article.updated_at }}</p>
      </div>
    </div>
  </aside>

  <div class="article-main">

    <!-- Read mode -->
    <article id="readMode" class="article-body markdown" aria-label="Article body">
      {{ rendered_html | safe }}
    </article>

    <!-- Edit mode -->
    <div id="editMode" class="article-editor hidden">
      {{ render_markdown_editor('body_content', article.body_content, project.slug, id="editorTextarea") }}
    </div>
  </div>
</div>

{{ render_markdown_modals() }}

<!-- Image Viewer Modal -->
<div id="imageViewerModal" class="modal hidden">
  <div class="modal-overlay"></div>
  <div class="modal-content modal-image">
    <button type="button" id="closeImageModal" class="btn-close" aria-label="Close">‚úï</button>
    <img id="modalImage" src="" alt="Full size image" class="modal-image-content">
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/markdown-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/article.js') }}"></script>
{% endblock %}