{% extends "base.html" %}

{% block title %}MythDB ¬∑ {{ project.name }} ¬∑ {{ article.title }}{% endblock %}

{% block content %}
<div class="article-layout">
  <aside class="sidebar" aria-label="Article metadata">
    <div class="card">
      <h3 class="card-title">Metadata</h3>
      <p class="card-meta"><strong>ID:</strong> {{ article.id }}</p>
      <p class="card-meta"><strong>Slug:</strong> {{ article.slug }}</p>
      <p class="card-meta"><strong>Created:</strong> {{ article.created_at }}</p>
      <p class="card-meta"><strong>Updated:</strong> {{ article.updated_at }}</p>
    </div>

    <div class="card">
      <h3 class="card-title">Structured fields</h3>
      <p class="card-meta muted">Coming next (field definitions + values).</p>
    </div>
  </aside>

  <div class="article-main">
    <header class="page-header">
      <p class="breadcrumb">
        <a href="{{ url_for('projects.projects_overview') }}">Projects</a>
        <span aria-hidden="true">/</span>
        <a href="{{ url_for('projects.project_home', slug=project.slug) }}">{{ project.name }}</a>
        <span aria-hidden="true">/</span>
        <span>{{ article.title }}</span>
      </p>

      <div class="article-header-row">
        <div>
          <h2>{{ article.title }}</h2>
          <p class="muted">
            <strong>Type:</strong> {{ article.type_name }}
            <span aria-hidden="true">¬∑</span>
            <strong>Slug:</strong> <code>{{ article.slug }}</code>
          </p>
        </div>
        <button id="modeToggle" class="btn" data-mode="read">‚úèÔ∏è Edit</button>
      </div>
    </header>

    <!-- Read mode -->
    <article id="readMode" class="article-body markdown" aria-label="Article body">
      {{ rendered_html | safe }}
    </article>

    <!-- Edit mode -->
    <form id="editMode" method="post" action="{{ url_for('articles.edit_article', slug=project.slug, article_id=article.id) }}" class="article-editor hidden">
      <div class="editor-toolbar">
        <button type="button" id="linkArticleBtn" class="btn btn-secondary" title="Link to another article">üîó Link Article</button>
        
        <!-- Article Link Dropdown -->
        <div id="linkDropdown" class="article-link-dropdown hidden">
          <input 
            type="text" 
            id="articleSearchInput" 
            class="article-search" 
            placeholder="Search articles..."
            spellcheck="false"
          >
          <div id="articleList" class="article-dropdown-list"></div>
        </div>
      </div>
      
      <textarea 
        name="body_content" 
        class="editor-textarea" 
        id="editorTextarea"
        required 
        placeholder="Write your markdown here..."
        spellcheck="false"
      >{{ article.body_content }}</textarea>

      <div class="editor-actions">
        <button type="submit" class="btn">üíæ Save</button>
        <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const modeToggle = document.getElementById('modeToggle');
  const readMode = document.getElementById('readMode');
  const editMode = document.getElementById('editMode');
  const cancelEdit = document.getElementById('cancelEdit');
  
  let currentMode = 'read';

  modeToggle.addEventListener('click', () => {
    if (currentMode === 'read') {
      // Switch to edit
      readMode.classList.add('hidden');
      editMode.classList.remove('hidden');
      modeToggle.textContent = 'üëÅÔ∏è View';
      modeToggle.dataset.mode = 'edit';
      currentMode = 'edit';
      editMode.querySelector('textarea').focus();
    } else {
      // Switch to read
      readMode.classList.remove('hidden');
      editMode.classList.add('hidden');
      modeToggle.textContent = '‚úèÔ∏è Edit';
      modeToggle.dataset.mode = 'read';
      currentMode = 'read';
    }
  });

  cancelEdit.addEventListener('click', () => {
    // Reset textarea to original content
    const textarea = editMode.querySelector('textarea');
    textarea.value = textarea.defaultValue;
    // Switch back to read mode
    modeToggle.click();
  });

  // Article linking functionality
  const linkArticleBtn = document.getElementById('linkArticleBtn');
  const linkDropdown = document.getElementById('linkDropdown');
  const articleSearchInput = document.getElementById('articleSearchInput');
  const articleList = document.getElementById('articleList');
  const editorTextarea = document.getElementById('editorTextarea');
  
  let allArticles = [];

  // Fetch articles from API
  async function loadArticles() {
    const projectSlug = '{{ project.slug }}';
    const articleId = {{ article.id }};
    
    try {
      const response = await fetch(`/projects/${projectSlug}/api/articles?exclude_id=${articleId}`);
      if (response.ok) {
        allArticles = await response.json();
        renderArticleList(allArticles);
      }
    } catch (error) {
      console.error('Failed to load articles:', error);
    }
  }

  // Render article list
  function renderArticleList(articles) {
    if (articles.length === 0) {
      articleList.innerHTML = '<div class="article-dropdown-empty">No articles found</div>';
      return;
    }
    
    articleList.innerHTML = articles.map(article => `
      <div class="article-dropdown-item" data-slug="${article.slug}" data-title="${article.title}">
        <div class="article-dropdown-title">${article.title}</div>
        <div class="article-dropdown-type">${article.type_name}</div>
      </div>
    `).join('');
    
    // Add click handlers to items
    document.querySelectorAll('.article-dropdown-item').forEach(item => {
      item.addEventListener('click', () => {
        insertArticleLink(item.dataset.slug, item.dataset.title);
        linkDropdown.classList.add('hidden');
      });
    });
  }

  // Filter articles based on search
  function filterArticles(searchTerm) {
    const filtered = allArticles.filter(article => 
      article.title.toLowerCase().includes(searchTerm.toLowerCase())
    );
    renderArticleList(filtered);
  }

  // Insert article link at cursor position
  function insertArticleLink(slug, title) {
    const textarea = editorTextarea;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const beforeCursor = textarea.value.substring(0, start);
    const afterCursor = textarea.value.substring(end);
    const markdownLink = `[${title}](article:${slug})`;
    
    textarea.value = beforeCursor + markdownLink + afterCursor;
    
    // Set cursor position after the inserted link
    const newPosition = start + markdownLink.length;
    textarea.selectionStart = newPosition;
    textarea.selectionEnd = newPosition;
    textarea.focus();
  }

  // Toggle dropdown on button click
  linkArticleBtn.addEventListener('click', (e) => {
    e.preventDefault();
    linkDropdown.classList.toggle('hidden');
    if (!linkDropdown.classList.contains('hidden')) {
      articleSearchInput.focus();
    }
  });

  // Filter articles as user types
  articleSearchInput.addEventListener('input', (e) => {
    filterArticles(e.target.value);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#linkArticleBtn') && !e.target.closest('#linkDropdown')) {
      linkDropdown.classList.add('hidden');
    }
  });

  // Load articles on page load
  loadArticles();
</script>
{% endblock %}
