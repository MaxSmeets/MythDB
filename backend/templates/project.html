{% extends "base.html" %}

{% macro render_folder(node, project_slug) %}
{% if node.folders and node.folders|length > 0 %}
  {% for folder in node.folders %}
    <li class="tree-folder" data-folder-id="{{ folder.id }}">
      <div class="tree-row">
        <button type="button" class="tree-toggle" aria-label="Toggle folder" aria-expanded="false">
          <span class="toggle-icon">â–¶</span>
        </button>
        <span class="tree-name">ğŸ“ {{ folder.name }}</span>

        <div class="tree-folder-menu">
          <button type="button" class="tree-menu-btn" aria-label="Folder options" data-folder-id="{{ folder.id }}">â‹®</button>
          <div class="tree-dropdown" data-folder-id="{{ folder.id }}">
            <button class="dropdown-item" data-action="new-folder" data-parent-id="{{ folder.id }}">â• Folder</button>
            <button class="dropdown-item" data-action="new-article" data-parent-id="{{ folder.id }}">â• Article</button>
            <button class="dropdown-item dropdown-warning" data-action="rename-folder" data-folder-id="{{ folder.id }}">âœï¸ Rename</button>
            <form method="post" action="{{ url_for('folders.delete_folder_route', slug=project_slug, folder_id=folder.id) }}" style="margin: 0; display: inline;">
              <button type="submit" class="dropdown-item dropdown-danger" onclick="return confirm('Delete folder? It must be empty.');">ğŸ—‘ï¸ Delete</button>
            </form>
          </div>
        </div>
      </div>

      {% if folder.articles and folder.articles|length > 0 %}
      <ul class="tree-articles tree-collapsible hidden">
        {% for article in folder.articles %}
          <li class="tree-article" data-article-id="{{ article.id }}">
            <div class="tree-article-row">
              <span class="tree-article-name">ğŸ“ <a href="{{ url_for('articles.article_view', slug=project_slug, article_id=article.id) }}">{{ article.title }}</a></span>
              <div class="tree-article-actions">
                <button type="button" class="article-action-btn" aria-label="Rename article" title="Rename">âœï¸</button>
                <form method="post" action="{{ url_for('articles.delete_article_route', slug=project_slug, article_id=article.id) }}" style="margin: 0; display: inline;">
                  <button type="submit" class="article-action-btn article-action-danger" aria-label="Delete article" title="Delete" onclick="return confirm('Delete article? This cannot be undone.');">ğŸ—‘ï¸</button>
                </form>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if folder.folders and folder.folders|length > 0 %}
      <ul class="tree-children tree-collapsible hidden">
        {{ render_folder(folder, project_slug) }}
      </ul>
      {% endif %}
    </li>
  {% endfor %}
{% endif %}
{% endmacro %}

{% block title %}MythDB Â· {{ project.name }}{% endblock %}

{% block content %}
<div class="project-layout" data-project-slug="{{ project.slug }}">
  <header class="page-header">
    <p class="breadcrumb">
      <a href="{{ url_for('projects.projects_overview') }}">Projects</a>
      <span aria-hidden="true">/</span>
      <span>{{ project.name }}</span>
    </p>
    <h2>{{ project.name }}</h2>
    <p class="muted"><strong>Genre:</strong> {{ project.genre }}</p>
  </header>

  <aside class="sidebar" aria-label="Project sidebar">
    <!-- Sidebar Tabs -->
    <div class="sidebar-tabs">
      <button class="sidebar-tab-btn active" data-tab="file-tree" title="File tree">ğŸ“</button>
      <button class="sidebar-tab-btn" data-tab="media" title="Media">ğŸ–¼ï¸</button>
      <button class="sidebar-tab-btn" data-tab="maps" title="Maps">ğŸ—ºï¸</button>
      <button class="sidebar-tab-btn" data-tab="timelines" title="Timelines">â³</button>
      <button class="sidebar-tab-btn" data-tab="variables" title="Variables">âš™ï¸</button>
    </div>

    <!-- Tab Content -->
    <div class="sidebar-tab-content">
      
      <!-- Tab 1: File Tree -->
      <div class="sidebar-tab-panel active" id="file-tree-panel">
        {% if error %}
          <p class="alert" role="alert">{{ error }}</p>
        {% endif %}

        <section class="tree" aria-label="Folder tree">
          <ul class="tree-root">
            {% set root_folder = none %}
            {% for folder in tree.folders if folder.slug == 'root' %}
              {% set root_folder = folder %}
            {% endfor %}

            <!-- Root Section: Always at top, no folder styling -->
            <li class="tree-section">
              <div class="tree-row">
                <span class="tree-name">ğŸ“‹ Root</span>
                <div class="tree-folder-menu">
                  <button type="button" class="tree-menu-btn" aria-label="Folder options" data-folder-id="">â‹®</button>
                  <div class="tree-dropdown" data-folder-id="">
                    <button class="dropdown-item" data-action="new-folder" data-parent-id="">+ Folder</button>
                    <button class="dropdown-item" data-action="new-article" data-parent-id="">+ Article</button>
                  </div>
                </div>
              </div>

              <!-- Root level articles -->
              {% if tree.articles and tree.articles|length > 0 %}
              <ul class="tree-articles">
                {% for article in tree.articles %}
                  <li class="tree-article" data-article-id="{{ article.id }}">
                    <div class="tree-article-row">
                      <span class="tree-article-name">ğŸ“ <a href="{{ url_for('articles.article_view', slug=project.slug, article_id=article.id) }}">{{ article.title }}</a></span>
                      <div class="tree-article-actions">
                        <button type="button" class="article-action-btn" aria-label="Rename article" title="Rename">âœï¸</button>
                        <form method="post" action="{{ url_for('articles.delete_article_route', slug=project.slug, article_id=article.id) }}" style="margin: 0; display: inline;">
                          <button type="submit" class="article-action-btn article-action-danger" aria-label="Delete article" title="Delete" onclick="return confirm('Delete article? This cannot be undone.');">ğŸ—‘ï¸</button>
                        </form>
                      </div>
                    </div>
                  </li>
                {% endfor %}
              </ul>
              {% endif %}

              <!-- Root folder's subfolders (if any) -->
              {% if root_folder and root_folder.folders and root_folder.folders|length > 0 %}
              <ul class="tree-children">
                {{ render_folder(root_folder, project.slug) }}
              </ul>
              {% endif %}
            </li>

            <!-- Other folders (exclude Root) -->
            {% if tree.folders and tree.folders|length > 0 %}
              {% for folder in tree.folders if folder.slug != 'root' %}
                <li class="tree-folder" data-folder-id="{{ folder.id }}">
                  <div class="tree-row">
                    <button type="button" class="tree-toggle" aria-label="Toggle folder" aria-expanded="false">
                      <span class="toggle-icon">â–¶</span>
                    </button>
                    <span class="tree-name">ğŸ“ {{ folder.name }}</span>

                    <div class="tree-folder-menu">
                      <button type="button" class="tree-menu-btn" aria-label="Folder options" data-folder-id="{{ folder.id }}">â‹®</button>
                      <div class="tree-dropdown" data-folder-id="{{ folder.id }}">
                        <button class="dropdown-item" data-action="new-folder" data-parent-id="{{ folder.id }}">â• Folder</button>
                        <button class="dropdown-item" data-action="new-article" data-parent-id="{{ folder.id }}">â• Article</button>
                        <button class="dropdown-item dropdown-warning" data-action="rename-folder" data-folder-id="{{ folder.id }}">âœï¸ Rename</button>
                        <form method="post" action="{{ url_for('folders.delete_folder_route', slug=project.slug, folder_id=folder.id) }}" style="margin: 0; display: inline;">
                          <button type="submit" class="dropdown-item dropdown-danger" onclick="return confirm('Delete folder? It must be empty.');">ğŸ—‘ï¸ Delete</button>
                        </form>
                      </div>
                    </div>
                  </div>

                  {% if folder.articles and folder.articles|length > 0 %}
                  <ul class="tree-articles tree-collapsible hidden">
                    {% for article in folder.articles %}
                      <li class="tree-article" data-article-id="{{ article.id }}">
                        <div class="tree-article-row">
                          <span class="tree-article-name">ğŸ“ <a href="{{ url_for('articles.article_view', slug=project.slug, article_id=article.id) }}">{{ article.title }}</a></span>
                          <div class="tree-article-actions">
                            <button type="button" class="article-action-btn" aria-label="Rename article" title="Rename">âœï¸</button>
                            <form method="post" action="{{ url_for('articles.delete_article_route', slug=project.slug, article_id=article.id) }}" style="margin: 0; display: inline;">
                              <button type="submit" class="article-action-btn article-action-danger" aria-label="Delete article" title="Delete" onclick="return confirm('Delete article? This cannot be undone.');">ğŸ—‘ï¸</button>
                            </form>
                          </div>
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                  {% endif %}

                  {% if folder.folders and folder.folders|length > 0 %}
                  <ul class="tree-children tree-collapsible hidden">
                    {{ render_folder(folder, project.slug) }}
                  </ul>
                  {% endif %}
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </section>
      </div>

      <!-- Tab 2: Media -->
      <div class="sidebar-tab-panel" id="media-panel">
        <div class="media-sidebar">
          <!-- Search Bar -->
          <input 
            type="text" 
            id="mediaSidebarSearch" 
            class="media-search-input" 
            placeholder="Search media..."
            spellcheck="false"
          >

          <!-- Upload Button -->
          <form 
            id="mediaSidebarForm"
            method="post" 
            action="{{ url_for('media.media_upload', slug=project.slug) }}" 
            enctype="multipart/form-data"
            class="media-upload-form"
          >
            <label class="media-upload-label">
              <input type="file" name="file" accept="image/*" class="media-file-input" hidden>
              <span class="btn btn-primary media-upload-btn">â¬†ï¸ Upload Image</span>
            </label>
          </form>

          <!-- Media Grid -->
          <div id="mediaSidebarGrid" class="media-sidebar-grid"></div>
        </div>
      </div>

      <!-- Tab 3: Maps -->
      <div class="sidebar-tab-panel" id="maps-panel">
        <div class="sidebar-empty">
          <p class="text-muted">Maps feature coming soon...</p>
        </div>
      </div>

      <!-- Tab 4: Timelines -->
      <div class="sidebar-tab-panel" id="timelines-panel">
        <div class="sidebar-empty">
          <p class="text-muted">Timelines feature coming soon...</p>
        </div>
      </div>

      <!-- Tab 5: Variables -->
      <div class="sidebar-tab-panel" id="variables-panel">
        <div class="sidebar-empty">
          <p class="text-muted">Variables feature coming soon...</p>
        </div>
      </div>

    </div>
  </aside>

  <section class="project-main" aria-label="Project home">

    <!-- Project Statistics -->
    <section class="stats-section" aria-label="Project statistics">
      <div class="stat-item">
        <div class="stat-number">{{ stats.folders_count }}</div>
        <div class="stat-label">Folders</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ stats.articles_count }}</div>
        <div class="stat-label">Articles</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ stats.total_words }}</div>
        <div class="stat-label">Total Words</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ stats.words_per_article }}</div>
        <div class="stat-label">Words/Article</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ stats.words_per_day }}</div>
        <div class="stat-label">Words/Day</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ stats.media_count }}</div>
        <div class="stat-label">Media Files</div>
      </div>
    </section>

    <!-- Quick Guide -->
    <section class="quick-guide" id="quickGuide" aria-label="Getting started">
      <div class="quick-guide-header">
        <h3>Getting Started</h3>
        <button type="button" id="hideQuickGuide" class="btn-icon" aria-label="Hide quick guide" title="Hide quick guide">âœ•</button>
      </div>
      <div class="guide-cards">
        <div class="guide-card">
          <div class="guide-icon">ğŸ“</div>
          <h4>Organize with Folders</h4>
          <p>Use the sidebar to create folders and organize your articles by location, character groups, or any structure that makes sense for your world.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon">ğŸ“</div>
          <h4>Create Articles</h4>
          <p>Right-click on any folder to create a new article. Choose from 5 article types: NPCs, Locations, Settlements, Factions, and Items.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon">âœï¸</div>
          <h4>Write in Markdown</h4>
          <p>All articles support full Markdown formatting. Add bold, italics, lists, headings, links, code blocks, and more to bring your world to life.</p>
        </div>
      </div>
    </section>

    <!-- Recent Articles -->
    {% if stats.recent_articles and stats.recent_articles|length > 0 %}
    <section class="recent-articles card card-collapsible" id="recentArticlesCard" aria-label="Recently updated articles">
      <div class="card-header-row">
        <h3 class="card-title">Recently Updated</h3>
        <button type="button" class="btn-collapse" aria-expanded="true">â–¼</button>
      </div>
      <div class="article-list card-content" id="recentArticlesContent">
        {% for article in stats.recent_articles %}
        <div class="article-item">
          <div class="article-header">
            <a href="{{ url_for('articles.article_view', slug=project.slug, article_id=article.id) }}" class="article-title">
              {{ article.title }}
            </a>
            <span class="article-type">{{ article.type_name }}</span>
          </div>
          <p class="article-meta">{{ article.updated_at_formatted }} <span class="article-time-relative">[{{ article.updated_at_relative }}]</span></p>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  </section>
</div>

<!-- New Folder Modal -->
<dialog id="folderModal" aria-labelledby="folderModalTitle">
  <form method="post" action="{{ url_for('folders.create_folder_route', slug=project.slug) }}" class="modal">
    <div class="modal-container">
      <header class="modal-header">
        <h3 id="folderModalTitle">New folder</h3>
      </header>

      <div class="modal-body">
        <input type="hidden" name="parent_id" id="folderParentId" value="" />

        <label>
          <span>Folder name</span>
          <input name="name" type="text" required placeholder="e.g. Locations" />
        </label>

        <p class="muted"><small>This will be created inside the selected folder.</small></p>
      </div>

      <footer class="modal-footer">
        <button type="button" data-close="folderModal">Cancel</button>
        <button type="submit">Create</button>
      </footer>
    </div>
  </form>
</dialog>

<!-- New Article Modal -->
<dialog id="articleModal" aria-labelledby="articleModalTitle">
  <form method="post" action="{{ url_for('articles.create_article', slug=project.slug) }}" class="modal">
    <div class="modal-container">
      <header class="modal-header">
        <h3 id="articleModalTitle">New article</h3>
      </header>

      <div class="modal-body">
        <input type="hidden" name="folder_id" id="articleFolderId" value="" />

        <label>
          <span>Article title</span>
          <input name="title" type="text" required placeholder="e.g. The Ashen Serpents" />
        </label>

        <label>
          <span>Type</span>
          <select name="type_key" required>
            {% for t in types %}
              <option value="{{ t.key }}">{{ t.name }}</option>
            {% endfor %}
          </select>
        </label>

        <p class="muted"><small>This will create an article in the selected folder with markdown stored in the database.</small></p>
      </div>


      <footer class="modal-footer">
        <button type="button" data-close="articleModal">Cancel</button>
        <button type="submit">Create</button>
      </footer>
    </div>
  </form>
</dialog>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/project.js') }}"></script>
{% endblock %}
