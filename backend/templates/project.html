{% extends "base.html" %}

{% macro render_folder(node, project_slug) %}
{% if node.folders and node.folders|length > 0 %}
  {% for folder in node.folders %}
    <li class="tree-folder" data-folder-id="{{ folder.id }}">
      <div class="tree-row">
        <button type="button" class="tree-toggle" aria-label="Toggle folder" aria-expanded="true">
          <span class="toggle-icon">â–¼</span>
        </button>
        <span class="tree-name">ğŸ“ {{ folder.name }}</span>

        <div class="tree-folder-menu">
          <button type="button" class="tree-menu-btn" aria-label="Folder options" data-folder-id="{{ folder.id }}">â‹®</button>
          <div class="tree-dropdown" data-folder-id="{{ folder.id }}">
            <button class="dropdown-item" data-action="new-folder" data-parent-id="{{ folder.id }}">â• Folder</button>
            <button class="dropdown-item" data-action="new-article" data-parent-id="{{ folder.id }}">â• Article</button>
            <button class="dropdown-item dropdown-warning" data-action="rename-folder" data-folder-id="{{ folder.id }}">âœï¸ Rename</button>
            <button class="dropdown-item dropdown-danger" data-action="delete-folder" data-folder-id="{{ folder.id }}" onclick="return confirm('Delete folder? This will delete all contents.');">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      </div>

      {% if folder.articles and folder.articles|length > 0 %}
      <ul class="tree-articles tree-collapsible">
        {% for article in folder.articles %}
          <li class="tree-article">
            <div class="tree-article-row">
              <span class="tree-article-name">ğŸ“ <a href="{{ url_for('articles.article_view', slug=project_slug, article_id=article.id) }}">{{ article.title }}</a></span>
              <div class="tree-article-actions">
                <button type="button" class="article-action-btn" aria-label="Rename article" title="Rename">âœï¸</button>
                <form method="post" action="{{ url_for('articles.delete_article_route', slug=project_slug, article_id=article.id) }}" style="margin: 0; display: inline;">
                  <button type="submit" class="article-action-btn article-action-danger" aria-label="Delete article" title="Delete" onclick="return confirm('Delete article? This cannot be undone.');">ğŸ—‘ï¸</button>
                </form>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if folder.folders and folder.folders|length > 0 %}
      <ul class="tree-children tree-collapsible">
        {{ render_folder(folder, project_slug) }}
      </ul>
      {% endif %}
    </li>
  {% endfor %}
{% endif %}
{% endmacro %}

{% block title %}MythDB Â· {{ project.name }}{% endblock %}

{% block content %}
<div class="project-layout">
  <aside class="sidebar" aria-label="Project folders">
    <header class="sidebar-header">
      <h3>Project</h3>
      <p class="muted">{{ project.name }}</p>
      <p class="muted"><strong>Genre:</strong> {{ project.genre }}</p>
      <a class="card card-link" href="{{ url_for('media.project_media', slug=project.slug) }}">
      <h3 class="card-title">Media</h3>
      <p class="card-meta">Upload maps, images, symbols.</p>
    </a>
    </header>

    {% if error %}
      <p class="alert" role="alert">{{ error }}</p>
    {% endif %}

    <section class="tree" aria-label="Folder tree">
      <ul class="tree-root">
        {% set root_folder = none %}
        {% for folder in tree.folders if folder.slug == 'root' %}
          {% set root_folder = folder %}
        {% endfor %}

        <!-- Root Section: Always at top, no folder styling -->
        <li class="tree-section">
          <div class="tree-row">
            <span class="tree-name">ğŸ“‹ Root</span>
            <div class="tree-folder-menu">
              <button type="button" class="tree-menu-btn" aria-label="Folder options" data-folder-id="">â‹®</button>
              <div class="tree-dropdown" data-folder-id="">
                <button class="dropdown-item" data-action="new-folder" data-parent-id="">+ Folder</button>
                <button class="dropdown-item" data-action="new-article" data-parent-id="">+ Article</button>
              </div>
            </div>
          </div>

          <!-- Root level articles -->
          {% if tree.articles and tree.articles|length > 0 %}
          <ul class="tree-articles">
            {% for article in tree.articles %}
              <li class="tree-article">
                <div class="tree-article-row">
                  <span class="tree-article-name">ğŸ“ <a href="{{ url_for('articles.article_view', slug=project.slug, article_id=article.id) }}">{{ article.title }}</a></span>
                  <div class="tree-article-actions">
                    <button type="button" class="article-action-btn" aria-label="Rename article" title="Rename">âœï¸</button>
                    <form method="post" action="{{ url_for('articles.delete_article_route', slug=project.slug, article_id=article.id) }}" style="margin: 0; display: inline;">
                      <button type="submit" class="article-action-btn article-action-danger" aria-label="Delete article" title="Delete" onclick="return confirm('Delete article? This cannot be undone.');">ğŸ—‘ï¸</button>
                    </form>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
          {% endif %}

          <!-- Root folder's subfolders (if any) -->
          {% if root_folder and root_folder.folders and root_folder.folders|length > 0 %}
          <ul class="tree-children">
            {{ render_folder(root_folder, project.slug) }}
          </ul>
          {% endif %}
        </li>

        <!-- Other folders (exclude Root) -->
        {% if tree.folders and tree.folders|length > 0 %}
          {% for folder in tree.folders if folder.slug != 'root' %}
            <li class="tree-folder" data-folder-id="{{ folder.id }}">
              <div class="tree-row">
                <button type="button" class="tree-toggle" aria-label="Toggle folder" aria-expanded="true">
                  <span class="toggle-icon">â–¼</span>
                </button>
                <span class="tree-name">ğŸ“ {{ folder.name }}</span>

                <div class="tree-folder-menu">
                  <button type="button" class="tree-menu-btn" aria-label="Folder options" data-folder-id="{{ folder.id }}">â‹®</button>
                  <div class="tree-dropdown" data-folder-id="{{ folder.id }}">
                    <button class="dropdown-item" data-action="new-folder" data-parent-id="{{ folder.id }}">â• Folder</button>
                    <button class="dropdown-item" data-action="new-article" data-parent-id="{{ folder.id }}">â• Article</button>
                    <button class="dropdown-item dropdown-warning" data-action="rename-folder" data-folder-id="{{ folder.id }}">âœï¸ Rename</button>
                    <button class="dropdown-item dropdown-danger" data-action="delete-folder" data-folder-id="{{ folder.id }}" onclick="return confirm('Delete folder? This will delete all contents.');">ğŸ—‘ï¸ Delete</button>
                  </div>
                </div>
              </div>

              {% if folder.articles and folder.articles|length > 0 %}
              <ul class="tree-articles tree-collapsible">
                {% for article in folder.articles %}
                  <li class="tree-article">
                    <div class="tree-article-row">
                      <span class="tree-article-name">ğŸ“ <a href="{{ url_for('articles.article_view', slug=project.slug, article_id=article.id) }}">{{ article.title }}</a></span>
                      <div class="tree-article-actions">
                        <button type="button" class="article-action-btn" aria-label="Rename article" title="Rename">âœï¸</button>
                        <form method="post" action="{{ url_for('articles.delete_article_route', slug=project.slug, article_id=article.id) }}" style="margin: 0; display: inline;">
                          <button type="submit" class="article-action-btn article-action-danger" aria-label="Delete article" title="Delete" onclick="return confirm('Delete article? This cannot be undone.');">ğŸ—‘ï¸</button>
                        </form>
                      </div>
                    </div>
                  </li>
                {% endfor %}
              </ul>
              {% endif %}

              {% if folder.folders and folder.folders|length > 0 %}
              <ul class="tree-children tree-collapsible">
                {{ render_folder(folder, project.slug) }}
              </ul>
              {% endif %}
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    </section>
  </aside>

  <section class="project-main" aria-label="Project home">
    <header class="page-header">
      <p class="breadcrumb">
        <a href="{{ url_for('projects.projects_overview') }}">Projects</a>
        <span aria-hidden="true">/</span>
        <span>{{ project.name }}</span>
      </p>
      <h2>{{ project.name }}</h2>
      <p class="muted">Pick a folder on the left to create articles and structure your world.</p>
    </header>

    <section class="cards" aria-label="Project sections">
      <a class="card card-link" href="#">
        <h3 class="card-title">Articles</h3>
        <p class="card-meta">Browse and search project articles (later).</p>
      </a>

      <a class="card card-link" href="#">
        <h3 class="card-title">Media</h3>
        <p class="card-meta">Maps, images, symbols (later).</p>
      </a>

      <a class="card card-link" href="#">
        <h3 class="card-title">Timeline</h3>
        <p class="card-meta">Events and chronology (later).</p>
      </a>
    </section>
  </section>
</div>

<!-- New Folder Modal -->
<dialog id="folderModal" aria-labelledby="folderModalTitle">
  <form method="post" action="{{ url_for('folders.create_folder_route', slug=project.slug) }}" class="modal">
    <header class="modal-header">
      <h3 id="folderModalTitle">New folder</h3>
    </header>

    <div class="modal-body">
      <input type="hidden" name="parent_id" id="folderParentId" value="" />

      <label>
        <span>Folder name</span>
        <input name="name" type="text" required placeholder="e.g. Locations" />
      </label>

      <p class="muted"><small>This will be created inside the selected folder.</small></p>
    </div>

    <footer class="modal-footer">
      <button type="button" data-close="folderModal">Cancel</button>
      <button type="submit">Create</button>
    </footer>
  </form>
</dialog>

<!-- New Article Modal -->
<dialog id="articleModal" aria-labelledby="articleModalTitle">
  <form method="post" action="{{ url_for('articles.create_article', slug=project.slug) }}" class="modal">
    <header class="modal-header">
      <h3 id="articleModalTitle">New article</h3>
    </header>

    <div class="modal-body">
      <input type="hidden" name="folder_id" id="articleFolderId" value="" />

      <label>
        <span>Article title</span>
        <input name="title" type="text" required placeholder="e.g. The Ashen Serpents" />
      </label>

      <label>
        <span>Type</span>
        <select name="type_key" required>
          {% for t in types %}
            <option value="{{ t.key }}">{{ t.name }}</option>
          {% endfor %}
        </select>
      </label>

      <p class="muted"><small>This will create an article in the selected folder with markdown stored in the database.</small></p>
    </div>


    <footer class="modal-footer">
      <button type="button" data-close="articleModal">Cancel</button>
      <button type="submit">Create</button>
    </footer>
  </form>
</dialog>
{% endblock %}

{% block scripts %}
<script>
  const folderModal = document.getElementById("folderModal");
  const articleModal = document.getElementById("articleModal");
  const folderParentId = document.getElementById("folderParentId");
  const articleFolderId = document.getElementById("articleFolderId");

  document.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const parentId = btn.getAttribute("data-parent-id") || "";
    const action = btn.getAttribute("data-action");

    if (action === "new-folder") {
      folderParentId.value = parentId;
      folderModal.showModal();
      folderModal.querySelector('input[name="name"]').focus();
    }

    if (action === "new-article") {
      articleFolderId.value = parentId;
      articleModal.showModal();
      articleModal.querySelector('input[name="title"]').focus();
    }
  });

  document.addEventListener("click", (e) => {
    const closeBtn = e.target.closest("[data-close]");
    if (!closeBtn) return;
    const id = closeBtn.getAttribute("data-close");
    document.getElementById(id).close();
  });

  // Click outside to close dialogs
  for (const modal of [folderModal, articleModal]) {
    modal.addEventListener("click", (e) => {
      const rect = modal.getBoundingClientRect();
      const clickedInDialog =
        rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
        rect.left <= e.clientX && e.clientX <= rect.left + rect.width;
      if (!clickedInDialog) modal.close();
    });
  }
</script>
{% endblock %}
